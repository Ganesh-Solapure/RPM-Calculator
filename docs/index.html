<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Engine RPM ↔ Speed Calculator</title>

  <!-- Minimal CSS: avoid heavy shadows and animations -->
  <style>
    :root{
      --bg:#0f1720; --card:#0b1220; --muted:#9aa6b2; --accent:#1f6feb; --panel:#101418; --text:#e6eef6;
      --max-width:1000px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071019 0%,var(--bg) 100%);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    .wrap{max-width:var(--max-width);margin:28px auto;padding:22px;}
    h1{font-size:2.4rem;margin:0 0 6px 0;font-weight:600}
    p.lead{margin:0 0 18px 0;color:var(--muted);font-size:0.95rem}
    .grid{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 220px;min-width:220px}
    label{display:block;color:var(--muted);font-size:0.9rem;margin-bottom:6px}
    input[type="number"], input[type="text"], select{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:#081018; color:var(--text);
      box-sizing:border-box; font-size:0.95rem;
    }
    button{
      padding:10px 14px;border-radius:10px;border:0;background:var(--panel);color:var(--text);cursor:pointer;font-weight:600;
    }
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .btn-primary{background:var(--accent);color:white}
    .panel{background:linear-gradient(180deg,#07121b 0%, #07141b 100%);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    pre#results{white-space:pre-wrap;background:#f6f7f9;color:#0b1320;padding:14px;border-radius:8px;border:1px solid rgba(0,0,0,0.05);overflow:auto}
    .muted{color:var(--muted)}
    canvas{width:100%;height:260px;display:block}
    @media (max-width:740px){ h1{font-size:1.6rem} canvas{height:200px} .col{min-width:100%} }
  </style>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Engine RPM ↔ Speed Calculator</h1>
    <p class="lead muted">Client-side RPM ↔ speed tool. Tyre code parsing, presets, chart, and secure WebSocket placeholder. Optimized for low CPU usage.</p>

    <section class="panel" aria-labelledby="inputs-heading">
      <h2 id="inputs-heading" style="margin:0 0 10px 0;font-size:1.1rem">Inputs</h2>

      <div class="grid">
        <div class="col">
          <label for="speed">Vehicle speed</label>
          <input id="speed" type="number" value="60" step="0.1" />
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <select id="speedUnit" style="width:110px">
              <option value="mph">mph</option>
              <option value="kmh">km/h</option>
            </select>
            <button id="calcBtn" class="btn-primary">Calculate</button>
          </div>
        </div>

        <div class="col">
          <label for="tireIn">Tire diameter (inches)</label>
          <input id="tireIn" type="number" value="23" step="0.01" />
          <div class="muted" style="font-size:0.85rem;margin-top:6px">or enter tyre code (e.g. <code>185/55R15</code>)</div>
        </div>

        <div class="col">
          <label for="tyreCode">Tyre code</label>
          <div style="display:flex;gap:8px">
            <input id="tyreCode" type="text" placeholder="185/55R15" />
            <button id="parseTyre">Parse</button>
          </div>
        </div>

        <div class="col">
          <label for="ratio">Transmission ratio</label>
          <input id="ratio" type="number" value="3.99" step="0.001" />
          <div style="margin-top:8px" class="muted small">Save presets for cars/gears below</div>
        </div>
      </div>

      <div class="controls" style="margin-top:12px">
        <button id="savePreset">Save preset</button>
        <select id="presets" style="min-width:160px"><option value="">-- choose --</option></select>
        <button id="delPreset">Delete preset</button>

        <div style="flex:1"></div>

        <input id="wsUrl" placeholder="wss://your-server.example/ws" style="padding:8px 10px;border-radius:8px;background:#071018;border:1px solid rgba(255,255,255,0.03);min-width:300px" />
        <button id="connectWs">Connect WS</button>
        <div id="wsStatus" class="muted" style="margin-left:8px">Not connected</div>
      </div>
    </section>

    <section style="margin-top:14px">
      <h3 style="margin:6px 0">Results</h3>
      <div class="panel">
        <pre id="results">Press Calculate</pre>
      </div>
    </section>

    <section style="margin-top:16px">
      <h3 style="margin:6px 0">RPM vs Speed (for current tire & ratio)</h3>
      <div class="panel">
        <canvas id="chart"></canvas>
      </div>
    </section>

    <section style="margin-top:16px">
      <h3 style="margin:6px 0">Live data (placeholder)</h3>
      <div class="panel">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted">Latest live payload:</div>
          <div id="liveOut" style="flex:1; color:var(--text); font-family:monospace; font-size:0.9rem; padding:6px 8px; background:#081018;border-radius:6px;overflow:auto; max-height:120px">No live data</div>
        </div>
      </div>
    </section>
  </div>

  <script>
  /**********************
   * Utility & formulas *
   **********************/
  const el = id => document.getElementById(id);

  function tyreDiameterFromCode(code) {
    const m = code.trim().match(/^(\d{3})\/(\d{2})R(\d{2})$/i);
    if (!m) return null;
    const width = Number(m[1]); // mm
    const aspect = Number(m[2]); // %
    const rim = Number(m[3]); // inches
    const sidewallIn = (width * (aspect/100)) / 25.4;
    return rim + 2*sidewallIn;
  }

  function wheelsRPM_from_speed(speed, unit, tireDiaIn) {
    let speed_mph = speed;
    if (unit === 'kmh') speed_mph = speed * 0.621371;
    return (speed_mph * 1056) / (Math.PI * tireDiaIn);
  }

  function engineRPM_from_wheels(wheelsRPM, ratio){ return wheelsRPM * ratio; }

  /*************************
   * Presets (localStorage) *
   *************************/
  const PRESETS_KEY = 'rpm_calc_presets_v1';
  function loadPresets(){ try { return JSON.parse(localStorage.getItem(PRESETS_KEY) || '{}'); } catch(e){ return {}; } }
  function savePresets(obj){ localStorage.setItem(PRESETS_KEY, JSON.stringify(obj)); }
  function refreshPresetList(){
    const sel = el('presets');
    const curr = sel.value;
    sel.innerHTML = '<option value="">-- choose --</option>';
    const ps = loadPresets();
    Object.keys(ps).forEach(k => {
      const o = document.createElement('option'); o.value = k; o.textContent = k; sel.appendChild(o);
    });
    if (curr && Array.from(sel.options).some(o => o.value === curr)) sel.value = curr;
  }

  /******************
   * Chart (single) *
   ******************/
  const chartCtx = el('chart').getContext('2d');
  // Chart options optimized for performance
  const CHART_OPTIONS = {
    type: 'line',
    data: {
      labels: [], datasets: [{
        label: 'Engine RPM',
        data: [],
        fill: false,
        tension: 0.15,
        pointRadius: 0 // reduce points cost
      }]
    },
    options: {
      animation: false, // disable animation
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true } },
      scales: {
        x: { title: { display:true, text: 'Speed (mph)' }, ticks: { maxTicksLimit: 12 } },
        y: { title: { display:true, text: 'Engine RPM' } }
      }
    }
  };
  const chart = new Chart(chartCtx, CHART_OPTIONS);

  function plotRPMvsSpeed(tire, ratio, unit) {
    // reduced sample: every 2 mph up to 140
    const speeds = [];
    const engine = [];
    for (let s = 0; s <= 140; s += 2) {
      speeds.push(s);
      const w = wheelsRPM_from_speed(s, unit, tire);
      engine.push(Math.round(engineRPM_from_wheels(w, ratio) * 100) / 100);
    }
    // update in place
    chart.data.labels = speeds;
    chart.data.datasets[0].data = engine;
    chart.update({duration: 0}); // instant update
  }

  /*********************
   * Calculation & UI  *
   *********************/
  function doCalc() {
    const speed = Number(el('speed').value);
    const unit = el('speedUnit').value;
    const tire = Number(el('tireIn').value);
    const ratio = Number(el('ratio').value);

    if (!speed || !tire || !ratio || isNaN(speed) || isNaN(tire) || isNaN(ratio)) {
      el('results').textContent = 'Please enter valid numbers for speed, tire diameter and transmission ratio.';
      return;
    }

    const wheelsRPM = wheelsRPM_from_speed(speed, unit, tire);
    const engineRPM = engineRPM_from_wheels(wheelsRPM, ratio);

    // Minimal, single DOM write
    el('results').textContent =
`Inputs:
  Speed: ${speed} ${unit}
  Tire diameter: ${tire.toFixed(3)} in
  Transmission ratio: ${ratio}

Results:
  Wheel RPM: ${wheelsRPM.toFixed(2)} rpm
  Engine RPM: ${engineRPM.toFixed(2)} rpm`;

    // update chart (fast)
    plotRPMvsSpeed(tire, ratio, unit);
  }

  // Debounce for calculate button (short lockout)
  let calcLock = false;
  el('calcBtn').addEventListener('click', () => {
    if (calcLock) return;
    calcLock = true;
    doCalc();
    setTimeout(() => { calcLock = false; }, 250); // 250 ms lockout
  });

  // parse tyre code
  el('parseTyre').addEventListener('click', () => {
    const code = el('tyreCode').value.trim();
    const d = tyreDiameterFromCode(code);
    if (d === null) {
      alert('Tyre code not recognized. Use format 185/55R15');
      return;
    }
    el('tireIn').value = d.toFixed(2);
  });

  // presets
  el('savePreset').addEventListener('click', () => {
    const name = prompt('Preset name? (e.g., MyCar_3rd)');
    if (!name) return;
    const ps = loadPresets();
    ps[name] = {
      speed: el('speed').value,
      speedUnit: el('speedUnit').value,
      tireIn: el('tireIn').value,
      ratio: el('ratio').value,
      tyreCode: el('tyreCode').value
    };
    savePresets(ps);
    refreshPresetList();
  });

  el('presets').addEventListener('change', () => {
    const k = el('presets').value;
    if (!k) return;
    const ps = loadPresets();
    const chosen = ps[k];
    el('speed').value = chosen.speed;
    el('speedUnit').value = chosen.speedUnit;
    el('tireIn').value = chosen.tireIn;
    el('ratio').value = chosen.ratio;
    el('tyreCode').value = chosen.tyreCode || '';
    doCalc();
  });

  el('delPreset').addEventListener('click', () => {
    const k = el('presets').value;
    if (!k) return alert('Choose a preset first');
    if (!confirm('Delete preset '+k+'?')) return;
    const ps = loadPresets(); delete ps[k]; savePresets(ps); refreshPresetList();
  });

  // init presets on load
  refreshPresetList();

  /************************
   * WebSocket (throttled)
   ************************/
  let ws = null;
  let lastWsUpdate = 0;
  const MIN_MS = 200; // throttle updates to 200ms (5Hz)

  function safeUpdateLiveUI(parsed) {
    // Only update minimal DOM fields to reduce paint
    if (parsed && typeof parsed === 'object') {
      const wheel = parsed.wheel_rpm ?? parsed.wheels_rpm ?? parsed.wheelRPM;
      const engine = parsed.engine_rpm ?? parsed.engineRPM;
      if (wheel !== undefined) {
        const engineCalc = engine !== undefined ? engine : (wheel * Number(el('ratio').value));
        el('liveOut').textContent = `wheel_rpm: ${Number(wheel).toFixed(2)}\nengine_rpm: ${Number(engineCalc).toFixed(2)}`;
        // Optionally update the results panel with a short live message
        el('results').textContent = `Live wheel rpm: ${Number(wheel).toFixed(2)} rpm\nLive engine rpm: ${Number(engineCalc).toFixed(2)} rpm`;
      } else {
        // fallback: show JSON only when it changes at throttled rate
        el('liveOut').textContent = JSON.stringify(parsed, null, 2);
      }
    } else {
      el('liveOut').textContent = String(parsed);
    }
  }

  el('connectWs').addEventListener('click', () => {
    const url = el('wsUrl').value.trim();
    if (!url) return alert('Enter a wss:// URL for secure WebSocket.');
    if (ws) {
      ws.close();
      ws = null;
      el('wsStatus').textContent = 'Disconnected';
      el('connectWs').textContent = 'Connect WS';
      return;
    }
    try {
      ws = new WebSocket(url);
      el('wsStatus').textContent = 'Connecting...';
      el('connectWs').textContent = 'Disconnect WS';

      ws.onopen = () => { el('wsStatus').textContent = 'Connected'; };
      ws.onerror = () => { el('wsStatus').textContent = 'WebSocket error'; };
      ws.onclose = () => { el('wsStatus').textContent = 'Closed'; ws = null; el('connectWs').textContent = 'Connect WS'; };

      ws.onmessage = (ev) => {
        const now = Date.now();
        // parse always, but throttle DOM update
        let parsed = null;
        try { parsed = JSON.parse(ev.data); } catch(e) { parsed = ev.data; }
        if (now - lastWsUpdate >= MIN_MS) {
          lastWsUpdate = now;
          // Update UI minimally
          safeUpdateLiveUI(parsed);
        }
      };
    } catch(e) {
      alert('WebSocket error: ' + (e.message || e));
      ws = null;
      el('wsStatus').textContent = 'Error';
    }
  });

  /*****************
   * Init default  *
   *****************/
  // initial calculate and plot (fast)
  doCalc();

  </script>
</body>
</html>
